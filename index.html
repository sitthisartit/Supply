<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ดจัดการสต็อกสินค้า</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #F5F5F4;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .tab-button.active {
            border-color: #A855F7;
            background-color: #F3E8FF;
            color: #7E22CE;
            font-weight: 600;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            text-align: center;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #A855F7;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            max-width: 90%;
            text-align: center;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p class="mt-4 text-lg text-stone-600">กำลังเชื่อมต่อฐานข้อมูล...</p>
    </div>

    <!-- Message Box for alerts -->
    <div id="message-box" class="hidden message-box">
        <div id="message-content" class="text-stone-700 text-lg mb-4"></div>
        <button id="message-close-btn" class="bg-purple-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">ตกลง</button>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header and User Info -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-stone-800">ระบบจัดการสต็อกสินค้า</h1>
            <p class="text-stone-500 mt-2">แดชบอร์ดสำหรับติดตามและจัดการสินค้าคงคลัง</p>
            <!-- Show User ID -->
            <div class="mt-4 p-2 bg-stone-100 rounded-lg shadow-inner">
                <span class="font-semibold text-stone-700">User ID:</span>
                <span id="user-id" class="text-sm font-mono text-purple-700">กำลังโหลด...</span>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="flex flex-wrap justify-center border-b border-stone-300 mb-8">
            <button data-tab="dashboard" class="tab-button active text-stone-600 py-3 px-6 border-b-2 border-transparent hover:border-purple-400 hover:bg-purple-50 transition-colors duration-300">ภาพรวม</button>
            <button data-tab="stock" class="tab-button text-stone-600 py-3 px-6 border-b-2 border-transparent hover:border-purple-400 hover:bg-purple-50 transition-colors duration-300">สินค้าคงเหลือ</button>
            <button data-tab="receive" class="tab-button text-stone-600 py-3 px-6 border-b-2 border-transparent hover:border-purple-400 hover:bg-purple-50 transition-colors duration-300">รับเข้าสินค้า</button>
            <button data-tab="issue" class="tab-button text-stone-600 py-3 px-6 border-b-2 border-transparent hover:border-purple-400 hover:bg-purple-50 transition-colors duration-300">จ่ายออกสินค้า</button>
            <button data-tab="stockByIV" class="tab-button text-stone-600 py-3 px-6 border-b-2 border-transparent hover:border-purple-400 hover:bg-purple-50 transition-colors duration-300">รายงานสต็อกแยก IV</button>
            <button data-tab="itemMovement" class="tab-button text-stone-600 py-3 px-6 border-b-2 border-transparent hover:border-purple-400 hover:bg-purple-50 transition-colors duration-300">ความเคลื่อนไหวสินค้า</button>
            <button data-tab="master" class="tab-button text-stone-600 py-3 px-6 border-b-2 border-transparent hover:border-purple-400 hover:bg-purple-50 transition-colors duration-300">ข้อมูลสินค้า</button>
        </nav>

        <!-- Main Content -->
        <main id="main-content">

            <!-- Dashboard View -->
            <section id="dashboard-view" class="tab-content space-y-8">
                <section>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                            <h3 class="text-lg font-semibold text-stone-500">จำนวนสินค้าทั้งหมด</h3>
                            <p id="total-products" class="text-4xl font-bold text-purple-600 mt-2">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                            <h3 class="text-lg font-semibold text-stone-500">จำนวนสินค้าคงคลังรวม</h3>
                            <p id="total-stock-quantity" class="text-4xl font-bold text-purple-600 mt-2">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                            <h3 class="text-lg font-semibold text-stone-500">รายการรับเข้าล่าสุด</h3>
                            <p id="total-receives" class="text-4xl font-bold text-green-600 mt-2">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                            <h3 class="text-lg font-semibold text-stone-500">รายการเบิกจ่ายล่าสุด</h3>
                            <p id="total-issues" class="text-4xl font-bold text-red-600 mt-2">0</p>
                        </div>
                    </div>
                </section>
                <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                        <h2 class="text-2xl font-bold text-stone-700 text-center mb-4">สินค้าคงเหลือ 5 อันดับแรก</h2>
                        <div class="chart-container">
                            <canvas id="top-products-chart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                        <h2 class="text-2xl font-bold text-stone-700 text-center mb-4">สัดส่วนการรับเข้า-เบิกจ่าย</h2>
                        <div class="chart-container">
                            <canvas id="movement-type-chart"></canvas>
                        </div>
                    </div>
                </section>
            </section>

            <!-- Stock Balance View -->
            <section id="stock-view" class="tab-content hidden">
                <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                    <h2 class="text-2xl font-bold text-stone-700 mb-4">สินค้าคงเหลือ</h2>
                    <p class="text-stone-500 mb-6">ตารางนี้แสดงยอดคงเหลือปัจจุบันของสินค้าทุกรายการ และคุณสามารถแก้ไขจำนวนสต็อกขั้นต่ำได้โดยตรงในตาราง</p>
                    <div class="flex flex-wrap gap-4 mb-4">
                        <input type="text" id="stock-search" placeholder="ค้นหาชื่อสินค้า..." class="flex-grow p-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors duration-300">
                        <button id="sort-by-name-btn" class="bg-purple-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-600 transition-colors duration-300 flex items-center gap-2">
                            <span>เรียงตามชื่อ</span>
                            <i class="fas fa-sort-alpha-down"></i>
                        </button>
                        <button id="sort-by-quantity-btn" class="bg-purple-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-600 transition-colors duration-300 flex items-center gap-2">
                            <span>เรียงตามจำนวน</span>
                            <i class="fas fa-sort-numeric-down"></i>
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-sm">
                            <thead class="bg-stone-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">ชื่อสินค้า</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">หน่วยนับ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">คงเหลือ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">สต็อกขั้นต่ำ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">สถานะ</th>
                                </tr>
                            </thead>
                            <tbody id="stock-balance-table-body" class="divide-y divide-stone-200">
                                <!-- Data will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Receive View -->
            <section id="receive-view" class="tab-content hidden space-y-8">
                <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                    <h2 class="text-2xl font-bold text-stone-700 mb-4">บันทึกรายการรับเข้า</h2>
                    <p class="text-stone-500 mb-6">ใช้ฟอร์มนี้เพื่อบันทึกรายการรับเข้าสินค้า หรือเลือกไฟล์ CSV เพื่อบันทึกหลายรายการพร้อมกัน</p>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Manual Receive Form -->
                        <div class="p-6 border border-stone-200 rounded-lg">
                            <h3 class="text-xl font-bold text-stone-700 mb-4">บันทึกรายการด้วยตนเอง</h3>
                            <form id="receive-form" class="space-y-4">
                                <div>
                                    <label for="receive-item" class="block text-stone-700 font-semibold mb-2">ชื่อสินค้า</label>
                                    <select id="receive-item" class="w-full p-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors duration-300"></select>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="receive-unit" class="block text-stone-700 font-semibold mb-2">หน่วยนับ</label>
                                        <input type="text" id="receive-unit" class="w-full p-3 border bg-stone-100 border-stone-300 rounded-lg" readonly>
                                    </div>
                                    <div>
                                        <label for="receive-quantity" class="block text-stone-700 font-semibold mb-2">จำนวน</label>
                                        <input type="number" id="receive-quantity" min="1" required class="w-full p-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors duration-300">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="receive-po" class="block text-stone-700 font-semibold mb-2">เลขที่ PO (ถ้ามี)</label>
                                        <input type="text" id="receive-po" class="w-full p-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors duration-300">
                                    </div>
                                    <div>
                                        <label for="receive-iv" class="block text-stone-700 font-semibold mb-2">เลขที่ IV</label>
                                        <input type="text" id="receive-iv" required class="w-full p-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors duration-300">
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">บันทึกรายการรับเข้า</button>
                            </form>
                        </div>
                        <!-- CSV Upload Section -->
                        <div class="p-6 border border-stone-200 rounded-lg">
                            <h3 class="text-xl font-bold text-stone-700 mb-4">อัปโหลด CSV</h3>
                            <p class="text-stone-500 mb-4">รูปแบบไฟล์: ชื่อสินค้า,จำนวน,เลขที่ PO,เลขที่ IV</p>
                            <div class="flex flex-col space-y-4">
                                <label for="receive-csv-upload" class="bg-green-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-600 transition-colors duration-300 cursor-pointer text-center">
                                    <i class="fas fa-upload mr-2"></i>
                                    เลือกไฟล์ CSV
                                </label>
                                <input type="file" id="receive-csv-upload" class="hidden" accept=".csv">
                                <button id="process-receive-csv-btn" class="bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors duration-300" disabled>
                                    ส่งประวัติการรับเข้าจากไฟล์ CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                    <h2 class="text-2xl font-bold text-stone-700 mb-4">ประวัติการรับเข้า</h2>
                    <button id="receive-csv-export" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors duration-300 mb-4 flex items-center gap-2">
                        <i class="fas fa-file-csv"></i>
                        ดาวน์โหลด CSV
                    </button>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-sm">
                            <thead class="bg-stone-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">วันที่</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">ชื่อสินค้า</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">จำนวน</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">หน่วยนับ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">เลขที่ PO</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">เลขที่ IV</th>
                                </tr>
                            </thead>
                            <tbody id="receive-table-body" class="divide-y divide-stone-200">
                                <!-- Data will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Issue View -->
            <section id="issue-view" class="tab-content hidden space-y-8">
                <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                    <h2 class="text-2xl font-bold text-stone-700 mb-4">บันทึกรายการจ่ายออก</h2>
                    <p class="text-stone-500 mb-6">ใช้ฟอร์มนี้เพื่อบันทึกรายการจ่ายออกสินค้า หรือเลือกไฟล์ CSV เพื่อบันทึกหลายรายการพร้อมกัน</p>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Manual Issue Form -->
                        <div class="p-6 border border-stone-200 rounded-lg">
                            <h3 class="text-xl font-bold text-stone-700 mb-4">บันทึกรายการด้วยตนเอง</h3>
                            <form id="issue-form" class="space-y-4">
                                <div>
                                    <label for="issue-item" class="block text-stone-700 font-semibold mb-2">ชื่อสินค้า</label>
                                    <select id="issue-item" class="w-full p-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors duration-300"></select>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="issue-unit" class="block text-stone-700 font-semibold mb-2">หน่วยนับ</label>
                                        <input type="text" id="issue-unit" class="w-full p-3 border bg-stone-100 border-stone-300 rounded-lg" readonly>
                                    </div>
                                    <div>
                                        <label for="issue-quantity" class="block text-stone-700 font-semibold mb-2">จำนวน</label>
                                        <input type="number" id="issue-quantity" min="1" required class="w-full p-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors duration-300">
                                    </div>
                                </div>
                                <div>
                                    <label for="issue-iv" class="block text-stone-700 font-semibold mb-2">เลขที่ IV</label>
                                    <select id="issue-iv" class="w-full p-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors duration-300"></select>
                                </div>
                                <div>
                                    <label for="issue-iv-stock" class="block text-stone-700 font-semibold mb-2">คงเหลือสำหรับ IV ที่เลือก</label>
                                    <span id="issue-iv-stock" class="block w-full p-3 bg-stone-100 border border-stone-300 rounded-lg font-mono text-purple-700">0</span>
                                </div>
                                <button type="submit" class="w-full bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">บันทึกรายการจ่ายออก</button>
                            </form>
                        </div>
                         <!-- CSV Upload Section -->
                         <div class="p-6 border border-stone-200 rounded-lg">
                            <h3 class="text-xl font-bold text-stone-700 mb-4">อัปโหลด CSV</h3>
                            <p class="text-stone-500 mb-4">รูปแบบไฟล์: ชื่อสินค้า,จำนวน,เลขที่ IV</p>
                            <div class="flex flex-col space-y-4">
                                <label for="issue-csv-upload" class="bg-green-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-600 transition-colors duration-300 cursor-pointer text-center">
                                    <i class="fas fa-upload mr-2"></i>
                                    เลือกไฟล์ CSV
                                </label>
                                <input type="file" id="issue-csv-upload" class="hidden" accept=".csv">
                                <button id="process-issue-csv-btn" class="bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors duration-300" disabled>
                                    ส่งประวัติการจ่ายออกจากไฟล์ CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                    <h2 class="text-2xl font-bold text-stone-700 mb-4">ประวัติการจ่ายออก</h2>
                    <button id="issue-csv-export" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors duration-300 mb-4 flex items-center gap-2">
                        <i class="fas fa-file-csv"></i>
                        ดาวน์โหลด CSV
                    </button>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-sm">
                            <thead class="bg-stone-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">วันที่</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">ชื่อสินค้า</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">จำนวน</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">หน่วยนับ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">เลขที่ IV</th>
                                </tr>
                            </thead>
                            <tbody id="issue-table-body" class="divide-y divide-stone-200">
                                <!-- Data will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Stock by IV Report View -->
            <section id="stockByIV-view" class="tab-content hidden">
                <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                    <h2 class="text-2xl font-bold text-stone-700 mb-4">รายงานสต็อกแยก IV</h2>
                    <p class="text-stone-500 mb-6">เลือกชื่อสินค้าเพื่อดูยอดคงเหลือแยกตามเลขที่ IV</p>
                    <div class="mb-4">
                        <label for="stock-by-iv-item" class="block text-stone-700 font-semibold mb-2">ชื่อสินค้า</label>
                        <select id="stock-by-iv-item" class="w-full p-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors duration-300"></select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-sm">
                            <thead class="bg-stone-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">เลขที่ IV</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">จำนวนคงเหลือ</th>
                                </tr>
                            </thead>
                            <tbody id="stock-by-iv-table-body" class="divide-y divide-stone-200">
                                <!-- Data will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Item Movement Report View -->
            <section id="itemMovement-view" class="tab-content hidden">
                <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                    <h2 class="text-2xl font-bold text-stone-700 mb-4">ความเคลื่อนไหวสินค้า</h2>
                    <p class="text-stone-500 mb-6">เลือกชื่อสินค้าเพื่อดูประวัติการรับเข้าและเบิกจ่ายทั้งหมด</p>
                    <div class="mb-4">
                        <label for="item-movement-item" class="block text-stone-700 font-semibold mb-2">ชื่อสินค้า</label>
                        <select id="item-movement-item" class="w-full p-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors duration-300"></select>
                    </div>
                    <p class="text-lg font-semibold text-stone-700 mb-4">ยอดคงเหลือปัจจุบัน: <span id="item-movement-current-stock" class="text-purple-600">0</span></p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-sm">
                            <thead class="bg-stone-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">วันที่</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">ประเภท</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">จำนวน</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">หน่วยนับ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">เลขที่ PO</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">เลขที่ IV</th>
                                </tr>
                            </thead>
                            <tbody id="item-movement-table-body" class="divide-y divide-stone-200">
                                <!-- Data will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Item Master View -->
            <section id="master-view" class="tab-content hidden space-y-8">
                <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                    <h2 class="text-2xl font-bold text-stone-700 mb-4">ข้อมูลสินค้า</h2>
                    <p class="text-stone-500 mb-6">ใช้ส่วนนี้เพื่อเพิ่ม, แก้ไข, หรือลบรายการสินค้าหลัก</p>
                    <form id="master-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="master-name" class="block text-stone-700 font-semibold mb-2">ชื่อสินค้า</label>
                                <input type="text" id="master-name" required class="w-full p-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors duration-300">
                            </div>
                            <div>
                                <label for="master-unit" class="block text-stone-700 font-semibold mb-2">หน่วยนับ</label>
                                <input type="text" id="master-unit" required class="w-full p-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors duration-300">
                            </div>
                            <div>
                                <label for="master-min-stock" class="block text-stone-700 font-semibold mb-2">สต็อกขั้นต่ำ</label>
                                <input type="number" id="master-min-stock" min="0" required class="w-full p-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors duration-300">
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">เพิ่มสินค้า</button>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                    <h2 class="text-2xl font-bold text-stone-700 mb-4">จัดการรายการสินค้าหลัก</h2>
                    <p class="text-stone-500 mb-6">คุณสามารถจัดการรายการสินค้าหลักทั้งหมดได้จากที่นี่</p>
                    
                    <!-- CSV Import/Export Controls -->
                    <div class="flex flex-wrap items-center gap-4 mb-4">
                        <button id="master-csv-export" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors duration-300 flex items-center gap-2">
                            <i class="fas fa-download"></i>
                            ดาวน์โหลด CSV
                        </button>
                        <label for="master-csv-upload" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors duration-300 cursor-pointer flex items-center gap-2">
                            <i class="fas fa-upload"></i>
                            อัปโหลด CSV
                        </label>
                        <input type="file" id="master-csv-upload" class="hidden" accept=".csv">
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-sm">
                            <thead class="bg-stone-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">ชื่อสินค้า</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">หน่วยนับ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">สต็อกขั้นต่ำ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="master-table-body" class="divide-y divide-stone-200">
                                <!-- Data will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            addDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            runTransaction,
            getDocs,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase and data
        let app;
        let db;
        let auth;
        let userId;
        let appId; // <-- Correctly defined global variable

        let itemMasterData = {}; // Stores item master data by itemId
        let stockBalanceData = {}; // Stores stock balance data by itemId
        let transactionsData = []; // Stores all transaction history
        let stockByIVData = {}; // New: Stores stock by IV number

        // --- UI Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const mainContent = document.getElementById('main-content');
        const userIdSpan = document.getElementById('user-id');
        const tabButtons = document.querySelectorAll('.tab-button');
        const messageBox = document.getElementById('message-box');
        const messageContent = document.getElementById('message-content');
        const messageCloseBtn = document.getElementById('message-close-btn');

        // --- Dashboard Elements ---
        const totalProductsSpan = document.getElementById('total-products');
        const totalStockQuantitySpan = document.getElementById('total-stock-quantity');
        const totalReceivesSpan = document.getElementById('total-receives');
        const totalIssuesSpan = document.getElementById('total-issues');
        const topProductsChartCtx = document.getElementById('top-products-chart').getContext('2d');
        const movementTypeChartCtx = document.getElementById('movement-type-chart').getContext('2d');
        let topProductsChart;
        let movementTypeChart;

        // --- Stock Balance Elements ---
        const stockSearchInput = document.getElementById('stock-search');
        const stockBalanceTableBody = document.getElementById('stock-balance-table-body');
        const sortByNameBtn = document.getElementById('sort-by-name-btn');
        const sortByQuantityBtn = document.getElementById('sort-by-quantity-btn');

        // --- Receive View Elements ---
        const receiveForm = document.getElementById('receive-form');
        const receiveItemSelect = document.getElementById('receive-item');
        const receiveUnitInput = document.getElementById('receive-unit');
        const receiveQuantityInput = document.getElementById('receive-quantity');
        const receivePoInput = document.getElementById('receive-po');
        const receiveIvInput = document.getElementById('receive-iv');
        const receiveTableBody = document.getElementById('receive-table-body');
        const receiveCsvUploadInput = document.getElementById('receive-csv-upload');
        const processReceiveCsvBtn = document.getElementById('process-receive-csv-btn');
        let receiveCsvFile = null;

        // --- Issue View Elements ---
        const issueForm = document.getElementById('issue-form');
        const issueItemSelect = document.getElementById('issue-item');
        const issueUnitInput = document.getElementById('issue-unit');
        const issueIvSelect = document.getElementById('issue-iv'); // Updated to select
        const issueIvStockSpan = document.getElementById('issue-iv-stock'); // New element to display stock
        const issueQuantityInput = document.getElementById('issue-quantity');
        const issueTableBody = document.getElementById('issue-table-body');
        const issueCsvUploadInput = document.getElementById('issue-csv-upload');
        const processIssueCsvBtn = document.getElementById('process-issue-csv-btn');
        let issueCsvFile = null;

        // --- Stock by IV Report Elements ---
        const stockByIVItemSelect = document.getElementById('stock-by-iv-item');
        const stockByIVTableBody = document.getElementById('stock-by-iv-table-body');

        // --- Item Movement Report Elements ---
        const itemMovementItemSelect = document.getElementById('item-movement-item');
        const itemMovementCurrentStockSpan = document.getElementById('item-movement-current-stock');
        const itemMovementTableBody = document.getElementById('item-movement-table-body');

        // --- Master Data Elements ---
        const masterForm = document.getElementById('master-form');
        const masterNameInput = document.getElementById('master-name');
        const masterUnitInput = document.getElementById('master-unit');
        const masterMinStockInput = document.getElementById('master-min-stock');
        const masterTableBody = document.getElementById('master-table-body');
        const masterCsvExportBtn = document.getElementById('master-csv-export');
        const masterCsvUploadInput = document.getElementById('master-csv-upload');

        // --- Helper Functions ---
        function showMessage(message) {
            messageContent.textContent = message;
            messageBox.classList.remove('hidden');
        }

        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        function setLoading(isLoading) {
            loadingOverlay.style.display = isLoading ? 'flex' : 'none';
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            document.getElementById(`${tabName}-view`).classList.remove('hidden');

            tabButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            if (tabName === 'dashboard') {
                renderDashboardCharts();
            }
        }

        function arrayToCsv(data) {
            if (data.length === 0) return '';
            const header = Object.keys(data[0]).join(',');
            const rows = data.map(row =>
                Object.values(row)
                .map(v => (v === null || v === undefined ? '' : String(v)))
                .map(v => `"${v.replace(/"/g, '""')}"`)
                .join(',')
            );
            return [header, ...rows].join('\r\n');
        }

        function csvToArray(csv) {
            const lines = csv.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];
            const text = lines[0].startsWith('\ufeff') ? lines[0].substring(1) + '\n' + lines.slice(1).join('\n') : csv;
            const processedLines = text.split('\n').filter(line => line.trim() !== '');
            
            const headers = processedLines[0].split(',').map(header => header.trim().replace(/"/g, ''));
            const data = [];
            for (let i = 1; i < processedLines.length; i++) {
                const values = processedLines[i].split(',').map(value => value.trim().replace(/"/g, ''));
                if (values.length === headers.length) {
                    const obj = {};
                    for (let j = 0; j < headers.length; j++) {
                        const parsedValue = isNaN(Number(values[j])) || values[j] === '' ? values[j] : Number(values[j]);
                        obj[headers[j]] = parsedValue;
                    }
                    data.push(obj);
                }
            }
            return data;
        }

        function calculateStockByIV() {
            stockByIVData = {};
            transactionsData.forEach(t => {
                if (!t.itemId || !t.iv_number) return;
                
                if (!stockByIVData[t.itemId]) {
                    stockByIVData[t.itemId] = {};
                }
                if (!stockByIVData[t.itemId][t.iv_number]) {
                    stockByIVData[t.itemId][t.iv_number] = 0;
                }
                
                if (t.type === 'receive') {
                    stockByIVData[t.itemId][t.iv_number] += t.quantity;
                } else if (t.type === 'issue') {
                    stockByIVData[t.itemId][t.iv_number] -= t.quantity;
                }
            });
        }

        // --- Data Rendering Functions ---
        function renderDashboardCharts() {
            const sortedStock = Object.values(stockBalanceData)
                .sort((a, b) => b.quantity - a.quantity)
                .slice(0, 5);

            const topProductLabels = sortedStock.map(d => itemMasterData[d.itemId]?.name || 'Unknown');
            const topProductQuantities = sortedStock.map(d => d.quantity);

            if (topProductsChart) topProductsChart.destroy();
            if (movementTypeChart) movementTypeChart.destroy();

            topProductsChart = new Chart(topProductsChartCtx, {
                type: 'bar',
                data: {
                    labels: topProductLabels,
                    datasets: [{
                        label: 'คงเหลือ',
                        data: topProductQuantities,
                        backgroundColor: 'rgba(168, 85, 247, 0.6)',
                        borderColor: 'rgba(168, 85, 247, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });

            const receiveCount = transactionsData.filter(t => t.type === 'receive').length;
            const issueCount = transactionsData.filter(t => t.type === 'issue').length;

            movementTypeChart = new Chart(movementTypeChartCtx, {
                type: 'doughnut',
                data: {
                    labels: ['รับเข้า', 'เบิกจ่าย'],
                    datasets: [{
                        data: [receiveCount, issueCount],
                        backgroundColor: ['rgba(34, 197, 94, 0.6)', 'rgba(239, 68, 68, 0.6)'],
                        borderColor: ['rgba(34, 197, 94, 1)', 'rgba(239, 68, 68, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } }
                }
            });
        }

        function renderDashboardSummary() {
            totalProductsSpan.textContent = Object.keys(itemMasterData).length;
            const totalStock = Object.values(stockBalanceData).reduce((sum, item) => sum + item.quantity, 0);
            totalStockQuantitySpan.textContent = totalStock;
            totalReceivesSpan.textContent = transactionsData.filter(t => t.type === 'receive').length;
            totalIssuesSpan.textContent = transactionsData.filter(t => t.type === 'issue').length;
        }

        function renderStockBalanceTable(data = Object.values(stockBalanceData)) {
            stockBalanceTableBody.innerHTML = '';
            const filteredData = data.filter(item => {
                const itemName = itemMasterData[item.itemId]?.name || '';
                return itemName.toLowerCase().includes(stockSearchInput.value.toLowerCase());
            });

            filteredData.forEach(item => {
                const masterItem = itemMasterData[item.itemId];
                const isLowStock = masterItem && item.quantity < masterItem.minStock;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${masterItem ? masterItem.name : 'Unknown'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${masterItem ? masterItem.unit : ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${item.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${masterItem ? masterItem.minStock : ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isLowStock ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                            ${isLowStock ? 'สต็อกต่ำ' : 'ปกติ'}
                        </span>
                    </td>
                `;
                stockBalanceTableBody.appendChild(row);
            });
        }

        function renderReceiveTable() {
            receiveTableBody.innerHTML = '';
            const receiveHistory = transactionsData.filter(t => t.type === 'receive').sort((a, b) => b.timestamp - a.timestamp);
            receiveHistory.forEach(t => {
                const item = itemMasterData[t.itemId];
                if (item) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${new Date(t.timestamp).toLocaleDateString('th-TH')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${item.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${t.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${item.unit}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${t.po_number || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${t.iv_number || '-'}</td>
                    `;
                    receiveTableBody.appendChild(row);
                }
            });
        }

        function renderIssueTable() {
            issueTableBody.innerHTML = '';
            const issueHistory = transactionsData.filter(t => t.type === 'issue').sort((a, b) => b.timestamp - a.timestamp);
            issueHistory.forEach(t => {
                const item = itemMasterData[t.itemId];
                if (item) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${new Date(t.timestamp).toLocaleDateString('th-TH')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${item.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${t.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${item.unit}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${t.iv_number || '-'}</td>
                    `;
                    issueTableBody.appendChild(row);
                }
            });
        }

        function renderStockByIVReport(selectedItemId) {
            stockByIVTableBody.innerHTML = '';
            if (!selectedItemId) return;

            const transactionsForIV = transactionsData.filter(t => t.itemId === selectedItemId);
            const stockByIV = {};
            transactionsForIV.forEach(t => {
                if (!stockByIV[t.iv_number]) {
                    stockByIV[t.iv_number] = 0;
                }
                if (t.type === 'receive') {
                    stockByIV[t.iv_number] += t.quantity;
                } else if (t.type === 'issue') {
                    stockByIV[t.iv_number] -= t.quantity;
                }
            });

            for (const iv in stockByIV) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${iv}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${stockByIV[iv]}</td>
                `;
                stockByIVTableBody.appendChild(row);
            }
        }

        function renderItemMovementReport(selectedItemId) {
            itemMovementTableBody.innerHTML = '';
            if (!selectedItemId) {
                itemMovementCurrentStockSpan.textContent = '0';
                return;
            }
            itemMovementCurrentStockSpan.textContent = stockBalanceData[selectedItemId]?.quantity || '0';

            const movements = transactionsData.filter(t => t.itemId === selectedItemId).sort((a, b) => b.timestamp - a.timestamp);
            movements.forEach(t => {
                const item = itemMasterData[t.itemId];
                if (item) {
                    const row = document.createElement('tr');
                    const po_number = t.po_number || '-';
                    const iv_number = t.iv_number || '-';
                    const type_label = t.type === 'receive' ? 'รับเข้า' : 'เบิกจ่าย';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${new Date(t.timestamp).toLocaleDateString('th-TH')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${type_label}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${t.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${item.unit}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${po_number}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${iv_number}</td>
                    `;
                    itemMovementTableBody.appendChild(row);
                }
            });
        }

        function renderMasterTable() {
            masterTableBody.innerHTML = '';
            const masterItems = Object.entries(itemMasterData).sort(([, a], [, b]) => a.name.localeCompare(b.name, 'th'));

            masterItems.forEach(([itemId, item]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${item.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${item.unit}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">
                        <input type="number" value="${item.minStock}" min="0" data-item-id="${itemId}" class="p-1 border border-stone-300 rounded-md w-24 text-right focus:ring-1 focus:ring-purple-500">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button data-item-id="${itemId}" class="delete-btn text-red-600 hover:text-red-900 transition-colors duration-300">ลบ</button>
                    </td>
                `;
                masterTableBody.appendChild(row);
            });
        }

        // --- Data Listeners and Handlers ---
        function setupDataListeners() {
            if (!db || !userId || !appId) return;

            const basePath = `artifacts/${appId}/users/${userId}`;

            const itemMasterCol = collection(db, `${basePath}/item_master`);
            onSnapshot(itemMasterCol, (snapshot) => {
                itemMasterData = {};
                snapshot.forEach(doc => {
                    itemMasterData[doc.id] = { ...doc.data(), id: doc.id };
                });
                renderMasterTable();
                populateItemSelects();
                renderStockBalanceTable();
                renderDashboardSummary();
                renderDashboardCharts();
            });

            const stockBalanceCol = collection(db, `${basePath}/stock_balance`);
            onSnapshot(stockBalanceCol, (snapshot) => {
                stockBalanceData = {};
                snapshot.forEach(doc => {
                    stockBalanceData[doc.id] = { ...doc.data(), id: doc.id };
                });
                renderStockBalanceTable();
                renderDashboardSummary();
                renderDashboardCharts();
                const activeTab = document.querySelector('.tab-button.active').dataset.tab;
                if (activeTab === 'stockByIV') renderStockByIVReport(stockByIVItemSelect.value);
                if (activeTab === 'itemMovement') renderItemMovementReport(itemMovementItemSelect.value);
            });

            const transactionsCol = collection(db, `${basePath}/transactions`);
            onSnapshot(transactionsCol, (snapshot) => {
                transactionsData = [];
                snapshot.forEach(doc => {
                    transactionsData.push({ ...doc.data(), id: doc.id });
                });
                calculateStockByIV();
                renderDashboardSummary();
                renderDashboardCharts();
                renderReceiveTable();
                renderIssueTable();
                populateIssueIvSelect();
                const activeTab = document.querySelector('.tab-button.active').dataset.tab;
                if (activeTab === 'stockByIV') renderStockByIVReport(stockByIVItemSelect.value);
                if (activeTab === 'itemMovement') renderItemMovementReport(itemMovementItemSelect.value);
            });
        }

        function populateItemSelects() {
            const selects = [receiveItemSelect, issueItemSelect, stockByIVItemSelect, itemMovementItemSelect];
            selects.forEach(select => {
                const currentVal = select.value;
                select.innerHTML = '<option value="">-- เลือกสินค้า --</option>';
                const sortedItems = Object.values(itemMasterData).sort((a, b) => a.name.localeCompare(b.name, 'th'));
                sortedItems.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name;
                    select.appendChild(option);
                });
                select.value = currentVal;
            });
            updateUnitFields();
        }

        function populateIssueIvSelect() {
            issueIvSelect.innerHTML = '<option value="">-- เลือก IV --</option>';
            const selectedItemId = issueItemSelect.value;

            if (!selectedItemId || !stockByIVData[selectedItemId]) {
                issueIvStockSpan.textContent = '0';
                return;
            }

            const ivsForSelectedItem = stockByIVData[selectedItemId];
            const sortedIVs = Object.keys(ivsForSelectedItem).sort();

            sortedIVs.forEach(iv => {
                const quantity = ivsForSelectedItem[iv];
                if (quantity > 0) {
                    const option = document.createElement('option');
                    option.value = iv;
                    option.textContent = `${iv} (เหลือ: ${quantity})`;
                    issueIvSelect.appendChild(option);
                }
            });
            
            updateIssueIvStockDisplay();
        }

        function updateIssueIvStockDisplay() {
            const selectedItemId = issueItemSelect.value;
            const selectedIv = issueIvSelect.value;
            if (selectedItemId && selectedIv && stockByIVData[selectedItemId]?.[selectedIv]) {
                issueIvStockSpan.textContent = stockByIVData[selectedItemId][selectedIv];
            } else {
                issueIvStockSpan.textContent = '0';
            }
        }

        function updateUnitFields() {
            const receiveItemId = receiveItemSelect.value;
            const issueItemId = issueItemSelect.value;

            receiveUnitInput.value = receiveItemId ? (itemMasterData[receiveItemId]?.unit || '') : '';
            issueUnitInput.value = issueItemId ? (itemMasterData[issueItemId]?.unit || '') : '';
        }
        
        // --- Event Listeners ---
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        messageCloseBtn.addEventListener('click', hideMessage);

        stockSearchInput.addEventListener('input', () => {
            const searchText = stockSearchInput.value.toLowerCase();
            const filteredData = Object.values(stockBalanceData).filter(item => {
                const itemName = itemMasterData[item.itemId]?.name || '';
                return itemName.toLowerCase().includes(searchText);
            });
            renderStockBalanceTable(filteredData);
        });

        sortByNameBtn.addEventListener('click', () => {
            const sortedData = Object.values(stockBalanceData).sort((a, b) => {
                const nameA = itemMasterData[a.itemId]?.name || '';
                const nameB = itemMasterData[b.itemId]?.name || '';
                return nameA.localeCompare(nameB, 'th');
            });
            renderStockBalanceTable(sortedData);
        });

        sortByQuantityBtn.addEventListener('click', () => {
            const sortedData = Object.values(stockBalanceData).sort((a, b) => a.quantity - b.quantity);
            renderStockBalanceTable(sortedData);
        });

        masterTableBody.addEventListener('change', (e) => {
            if (e.target.type === 'number' && e.target.dataset.itemId) {
                const itemId = e.target.dataset.itemId;
                const newMinStock = parseInt(e.target.value, 10);
                if (userId && !isNaN(newMinStock) && newMinStock >= 0) {
                    const itemDocRef = doc(db, `artifacts/${appId}/users/${userId}/item_master`, itemId);
                    updateDoc(itemDocRef, { minStock: newMinStock }).catch(error => {
                        console.error('Error updating min stock:', error);
                        showMessage('ไม่สามารถอัปเดตสต็อกขั้นต่ำได้');
                    });
                }
            }
        });

        masterTableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const itemId = e.target.dataset.itemId;
                if (userId && itemId) {
                    const itemName = itemMasterData[itemId]?.name;
                    showMessage(`คุณต้องการลบสินค้า ${itemName} หรือไม่? ข้อมูลสต็อกที่เกี่ยวข้องจะถูกลบออกไปด้วย`);
                    document.getElementById('message-close-btn').onclick = async () => {
                        hideMessage();
                        try {
                            const basePath = `artifacts/${appId}/users/${userId}`;
                            await deleteDoc(doc(db, `${basePath}/item_master`, itemId));
                            await deleteDoc(doc(db, `${basePath}/stock_balance`, itemId));
                            
                            const q = query(collection(db, `${basePath}/transactions`), where("itemId", "==", itemId));
                            const snapshot = await getDocs(q);
                            snapshot.forEach(d => deleteDoc(doc(db, `${basePath}/transactions`, d.id)));
                        } catch (error) {
                            console.error('Error deleting item:', error);
                            showMessage('ไม่สามารถลบสินค้าได้');
                        }
                    };
                }
            }
        });
        
        masterForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const itemName = masterNameInput.value.trim();
            const itemUnit = masterUnitInput.value.trim();
            const minStock = parseInt(masterMinStockInput.value, 10);
            
            if (!itemName || !itemUnit || isNaN(minStock) || minStock < 0) {
                showMessage('กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง');
                return;
            }

            const isDuplicate = Object.values(itemMasterData).some(item => item.name.toLowerCase() === itemName.toLowerCase());
            if (isDuplicate) {
                showMessage(`สินค้าชื่อ "${itemName}" มีอยู่ในระบบแล้ว`);
                return;
            }

            if (!userId) {
                showMessage('ผู้ใช้ยังไม่ได้เข้าสู่ระบบ กรุณารอสักครู่');
                return;
            }
            
            try {
                const itemMasterCol = collection(db, `artifacts/${appId}/users/${userId}/item_master`);
                await addDoc(itemMasterCol, {
                    name: itemName,
                    unit: itemUnit,
                    minStock: minStock
                });
                showMessage(`เพิ่มสินค้า "${itemName}" สำเร็จ`);
                masterForm.reset();
            } catch (error) {
                console.error('Error adding new item:', error);
                showMessage('ไม่สามารถเพิ่มสินค้าได้');
            }
        });

        receiveItemSelect.addEventListener('change', updateUnitFields);
        
        receiveForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const itemId = receiveItemSelect.value;
            const quantity = parseInt(receiveQuantityInput.value, 10);
            const po_number = receivePoInput.value.trim();
            const iv_number = receiveIvInput.value.trim();

            if (!itemId || isNaN(quantity) || quantity <= 0 || !iv_number) {
                showMessage('กรุณากรอกข้อมูลรับเข้าให้ครบถ้วนและถูกต้อง');
                return;
            }

            if (!userId) {
                showMessage('ผู้ใช้ยังไม่ได้เข้าสู่ระบบ กรุณารอสักครู่');
                return;
            }

            setLoading(true);
            try {
                const basePath = `artifacts/${appId}/users/${userId}`;
                await runTransaction(db, async (transaction) => {
                    const stockRef = doc(db, `${basePath}/stock_balance`, itemId);
                    const transactionRef = doc(collection(db, `${basePath}/transactions`));

                    const stockDoc = await transaction.get(stockRef);
                    let newQuantity = quantity;
                    if (stockDoc.exists()) {
                        newQuantity = stockDoc.data().quantity + quantity;
                        transaction.update(stockRef, { quantity: newQuantity });
                    } else {
                        transaction.set(stockRef, { itemId, quantity: newQuantity });
                    }
                    
                    transaction.set(transactionRef, {
                        itemId, type: 'receive', quantity, timestamp: Date.now(), po_number: po_number || null, iv_number
                    });
                });
                showMessage('บันทึกการรับเข้าสินค้าสำเร็จ');
                receiveForm.reset();
                updateUnitFields();
            } catch (error) {
                console.error('Transaction failed: ', error);
                showMessage(`ไม่สามารถบันทึกการรับเข้าได้: ${error.message}`);
            } finally {
                setLoading(false);
            }
        });

        receiveCsvUploadInput.addEventListener('change', (e) => {
            receiveCsvFile = e.target.files[0];
            processReceiveCsvBtn.disabled = !receiveCsvFile;
            processReceiveCsvBtn.textContent = receiveCsvFile ? `ประมวลผลไฟล์: ${receiveCsvFile.name}` : 'ส่งประวัติการรับเข้าจากไฟล์ CSV';
        });

        processReceiveCsvBtn.addEventListener('click', () => {
            if (!receiveCsvFile || !userId) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const csvText = e.target.result;
                try {
                    const newTransactions = csvToArray(csvText);
                    if (newTransactions.length === 0) {
                        showMessage('ไฟล์ CSV ไม่มีข้อมูล');
                        return;
                    }
                    setLoading(true);
                    const basePath = `artifacts/${appId}/users/${userId}`;
                    const nameToIdMap = Object.values(itemMasterData).reduce((map, item) => ({ ...map, [item.name.toLowerCase()]: item.id }), {});
                    const batch = writeBatch(db);
                    let validTransactions = 0;

                    for (const row of newTransactions) {
                        const { 'ชื่อสินค้า': itemName, 'จำนวน': quantity, 'เลขที่ PO': po_number, 'เลขที่ IV': iv_number } = row;
                        const itemId = nameToIdMap[itemName?.toLowerCase()];

                        if (itemId && quantity > 0 && iv_number) {
                            const stockRef = doc(db, `${basePath}/stock_balance`, itemId);
                            const stockDoc = await getDoc(stockRef);
                            const newQuantity = (stockDoc.exists() ? stockDoc.data().quantity : 0) + quantity;
                            
                            batch.set(stockRef, { itemId, quantity: newQuantity }, { merge: true });
                            
                            const transactionRef = doc(collection(db, `${basePath}/transactions`));
                            batch.set(transactionRef, { itemId, type: 'receive', quantity, timestamp: Date.now(), po_number: po_number || null, iv_number });
                            validTransactions++;
                        }
                    }

                    if (validTransactions > 0) {
                        await batch.commit();
                        showMessage(`อัปโหลดรายการรับเข้าจากไฟล์ CSV สำเร็จ ${validTransactions} รายการ`);
                    } else {
                        showMessage('ไม่พบรายการที่ถูกต้องในไฟล์ CSV');
                    }
                } catch (error) {
                    console.error('Error uploading receive CSV:', error);
                    showMessage(`ไม่สามารถอัปโหลดไฟล์ CSV ได้: ${error.message}`);
                } finally {
                    setLoading(false);
                    receiveCsvUploadInput.value = '';
                    receiveCsvFile = null;
                    processReceiveCsvBtn.disabled = true;
                    processReceiveCsvBtn.textContent = 'ส่งประวัติการรับเข้าจากไฟล์ CSV';
                }
            };
            reader.readAsText(receiveCsvFile);
        });

        issueItemSelect.addEventListener('change', () => {
            updateUnitFields();
            populateIssueIvSelect();
        });

        issueIvSelect.addEventListener('change', updateIssueIvStockDisplay);

        issueForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const itemId = issueItemSelect.value;
            const iv_number = issueIvSelect.value;
            const quantity = parseInt(issueQuantityInput.value, 10);
            
            if (!itemId || !iv_number || isNaN(quantity) || quantity <= 0) {
                showMessage('กรุณากรอกข้อมูลจ่ายออกให้ครบถ้วนและถูกต้อง');
                return;
            }

            const currentIVStock = stockByIVData[itemId]?.[iv_number] || 0;
            if (quantity > currentIVStock) {
                showMessage(`จำนวนที่จ่ายออก (${quantity}) เกินกว่าสต็อกคงเหลือของ IV นี้ (${currentIVStock})`);
                return;
            }
            
            if (!userId) return;

            setLoading(true);
            try {
                const basePath = `artifacts/${appId}/users/${userId}`;
                await runTransaction(db, async (transaction) => {
                    const stockRef = doc(db, `${basePath}/stock_balance`, itemId);
                    const transactionRef = doc(collection(db, `${basePath}/transactions`));

                    const stockDoc = await transaction.get(stockRef);
                    if (!stockDoc.exists()) throw "ไม่พบสินค้าในสต็อก";

                    const newQuantity = stockDoc.data().quantity - quantity;
                    if (newQuantity < 0) throw `จำนวนที่จ่ายออก (${quantity}) เกินกว่าสต็อกคงเหลือรวม (${stockDoc.data().quantity})`;

                    transaction.update(stockRef, { quantity: newQuantity });
                    transaction.set(transactionRef, { itemId, type: 'issue', quantity, timestamp: Date.now(), iv_number });
                });
                showMessage('บันทึกการจ่ายออกสินค้าสำเร็จ');
                issueForm.reset();
                updateUnitFields();
            } catch (error) {
                console.error('Transaction failed: ', error);
                showMessage(`ไม่สามารถบันทึกการจ่ายออกได้: ${typeof error === 'string' ? error : error.message}`);
            } finally {
                setLoading(false);
            }
        });
        
        issueCsvUploadInput.addEventListener('change', (e) => {
            issueCsvFile = e.target.files[0];
            processIssueCsvBtn.disabled = !issueCsvFile;
            processIssueCsvBtn.textContent = issueCsvFile ? `ประมวลผลไฟล์: ${issueCsvFile.name}` : 'ส่งประวัติการจ่ายออกจากไฟล์ CSV';
        });

        processIssueCsvBtn.addEventListener('click', () => {
            if (!issueCsvFile || !userId) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const csvText = e.target.result;
                try {
                    const newTransactions = csvToArray(csvText);
                    if (newTransactions.length === 0) {
                        showMessage('ไฟล์ CSV ไม่มีข้อมูล');
                        return;
                    }
                    setLoading(true);
                    const basePath = `artifacts/${appId}/users/${userId}`;
                    const nameToIdMap = Object.values(itemMasterData).reduce((map, item) => ({ ...map, [item.name.toLowerCase()]: item.id }), {});
                    const batch = writeBatch(db);
                    let validTransactions = 0;

                    for (const row of newTransactions) {
                        const { 'ชื่อสินค้า': itemName, 'จำนวน': quantity, 'เลขที่ IV': iv_number } = row;
                        const itemId = nameToIdMap[itemName?.toLowerCase()];
                        const currentStock = stockBalanceData[itemId]?.quantity || 0;

                        if (itemId && quantity > 0 && iv_number) {
                            if (quantity > currentStock) {
                                console.error(`Skipping transaction for ${itemName}: insufficient total stock`);
                                continue;
                            }
                            
                            const stockRef = doc(db, `${basePath}/stock_balance`, itemId);
                            const newQuantity = currentStock - quantity;
                            
                            batch.update(stockRef, { quantity: newQuantity });
                            const transactionRef = doc(collection(db, `${basePath}/transactions`));
                            batch.set(transactionRef, { itemId, type: 'issue', quantity, timestamp: Date.now(), iv_number });
                            validTransactions++;
                        }
                    }

                    if (validTransactions > 0) {
                        await batch.commit();
                        showMessage(`อัปโหลดรายการจ่ายออกจากไฟล์ CSV สำเร็จ ${validTransactions} รายการ`);
                    } else {
                        showMessage('ไม่พบรายการที่ถูกต้องในไฟล์ CSV');
                    }
                } catch (error) {
                    console.error('Error uploading issue CSV:', error);
                    showMessage(`ไม่สามารถอัปโหลดไฟล์ CSV ได้: ${error.message}`);
                } finally {
                    setLoading(false);
                    issueCsvUploadInput.value = '';
                    issueCsvFile = null;
                    processIssueCsvBtn.disabled = true;
                    processIssueCsvBtn.textContent = 'ส่งประวัติการจ่ายออกจากไฟล์ CSV';
                }
            };
            reader.readAsText(issueCsvFile);
        });

        stockByIVItemSelect.addEventListener('change', (e) => renderStockByIVReport(e.target.value));
        itemMovementItemSelect.addEventListener('change', (e) => renderItemMovementReport(e.target.value));

        masterCsvExportBtn.addEventListener('click', () => {
            const masterItems = Object.values(itemMasterData).map(item => ({
                'ชื่อสินค้า': item.name, 'หน่วยนับ': item.unit, 'สต็อกขั้นต่ำ': item.minStock,
            }));
            const csv = arrayToCsv(masterItems);
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "item_master.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        masterCsvUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                const csvText = event.target.result;
                try {
                    const newItems = csvToArray(csvText);
                    if (newItems.length === 0) {
                        showMessage('ไฟล์ CSV ไม่มีข้อมูล');
                        return;
                    }
                    setLoading(true);
                    
                    const itemMasterCol = collection(db, `artifacts/${appId}/users/${userId}/item_master`);
                    const batch = writeBatch(db);
                    let addedCount = 0;
                    let skippedCount = 0;

                    const existingNames = Object.values(itemMasterData).map(item => item.name.toLowerCase());
                    
                    for (const item of newItems) {
                        const { 'ชื่อสินค้า': name, 'หน่วยนับ': unit, 'สต็อกขั้นต่ำ': minStock } = item;
                        if (name && unit && minStock !== undefined) {
                             if (existingNames.includes(name.toLowerCase())) {
                                console.log(`Skipping duplicate item from CSV: ${name}`);
                                skippedCount++;
                                continue;
                            }
                            const docRef = doc(itemMasterCol);
                            batch.set(docRef, { name, unit, minStock: Number(minStock) });
                            existingNames.push(name.toLowerCase());
                            addedCount++;
                        } else {
                            skippedCount++;
                        }
                    }

                    if(addedCount > 0) await batch.commit();
                    
                    let resultMessage = `อัปโหลด CSV สำเร็จ: เพิ่ม ${addedCount} รายการ`;
                    if (skippedCount > 0) resultMessage += `, ข้าม ${skippedCount} รายการ (ซ้ำ/ข้อมูลไม่ถูกต้อง)`;
                    showMessage(resultMessage);

                } catch (error) {
                    console.error('Error uploading CSV:', error);
                    showMessage(`ไม่สามารถอัปโหลดไฟล์ CSV ได้: ${error.message}`);
                } finally {
                    setLoading(false);
                    e.target.value = '';
                }
            };
            reader.readAsText(file);
        });

        document.getElementById('receive-csv-export').addEventListener('click', () => {
            const receives = transactionsData.filter(t => t.type === 'receive').map(t => {
                const item = itemMasterData[t.itemId];
                return {
                    'วันที่': new Date(t.timestamp).toLocaleDateString('th-TH'), 'ชื่อสินค้า': item ? item.name : 'Unknown', 'จำนวน': t.quantity, 'หน่วยนับ': item ? item.unit : '', 'เลขที่ PO': t.po_number || '-', 'เลขที่ IV': t.iv_number
                };
            });
            const csv = arrayToCsv(receives);
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "receive_history.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        document.getElementById('issue-csv-export').addEventListener('click', () => {
            const issues = transactionsData.filter(t => t.type === 'issue').map(t => {
                const item = itemMasterData[t.itemId];
                return {
                    'วันที่': new Date(t.timestamp).toLocaleDateString('th-TH'), 'ชื่อสินค้า': item ? item.name : 'Unknown', 'จำนวน': t.quantity, 'หน่วยนับ': item ? item.unit : '', 'เลขที่ IV': t.iv_number
                };
            });
            const csv = arrayToCsv(issues);
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "issue_history.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // --- Firebase Initialization and Auth ---
        function initFirebase() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyADPO1Ojk80tt3nX9c3wRD7eIS6fk6kJ2E",
                  authDomain: "my-stock-dashboard2.firebaseapp.com",
                  projectId: "my-stock-dashboard2",
                  storageBucket: "my-stock-dashboard2.firebasestorage.app",
                  messagingSenderId: "396230150158",
                  appId: "1:396230150158:web:2a4566917d4043d9ec145f",
                  measurementId: "G-5VZWQVDWNF"
                };
                
                // Use projectId for database paths
                appId = firebaseConfig.projectId; 

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
                
                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken)
                        .catch((error) => {
                            console.error("Error with custom token, signing in anonymously:", error);
                            signInAnonymously(auth);
                        });
                } else {
                    signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdSpan.textContent = userId;
                        setLoading(false);
                        mainContent.classList.remove('hidden');
                        setupDataListeners();
                    } else {
                        userId = null;
                        userIdSpan.textContent = 'N/A';
                        setLoading(false);
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                setLoading(false);
                showMessage("ไม่สามารถเชื่อมต่อ Firebase ได้ กรุณาลองใหม่ภายหลัง");
            }
        }
        
        // Initial setup
        window.onload = function() {
            initFirebase();
            switchTab('dashboard');
        };
    </script>
</body>
</html>
